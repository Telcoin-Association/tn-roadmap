<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEL Token Holder Analysis</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            display: none;
            margin-top: 30px;
        }
        .controls {
            display: none;
            text-align: center;
            margin-bottom: 20px;
        }
        .last-updated {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }
        .chain-toggle {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .chain-toggle button {
            margin: 0;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border: 1px solid #667eea;
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }
        .chain-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .button-row {
            margin-top: 15px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .excluded-addresses {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-value {
            font-size: 36px;
            font-weight: bold;
        }
        .summary-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        .loading-state {
            text-align: center;
            color: #444;
            font-size: 16px;
            padding: 15px;
        }
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TEL Token Holder Analysis Tool</h1>
        
        <div id="alerts"></div>

        <div id="loadingState" class="loading-state">Loading latest holder snapshot...</div>

        <div id="controls" class="controls">
            <div id="lastUpdated" class="last-updated"></div>
            <div id="chainToggle" class="chain-toggle"></div>
            <div class="button-row">
                <button onclick="downloadResults()" id="downloadBtn" disabled>Download Current View (CSV)</button>
            </div>
        </div>

        <div class="results" id="results">
            <div class="summary-card" id="summaryCard"></div>
            
            <h2>Concentration Metrics (Retail Holders Only)</h2>
            <div class="metrics-grid" id="metricsGrid"></div>
            
            <h2>Excluded Non-Retail Addresses</h2>
            <div class="excluded-addresses" id="excludedAddresses"></div>
            
            <h2>Top Retail Holders</h2>
            <table id="topHoldersTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Address</th>
                        <th>Balance (TEL)</th>
                        <th>% of Supply</th>
                        <th>Chain</th>
                    </tr>
                </thead>
                <tbody id="topHoldersBody"></tbody>
            </table>
            
            <h2>Distribution Analysis</h2>
            <div id="distributionAnalysis"></div>
        </div>
    </div>

        <script>
        const TOTAL_TEL_SUPPLY = 92577234366;
        const RETAIL_THRESHOLD = 1000;
        const MEGA_HOLDER_THRESHOLD = 20000000000;

        let telData = null;
        let currentView = 'combined';

        document.addEventListener('DOMContentLoaded', () => {
            loadSnapshot();
        });

        async function loadSnapshot() {
            const loadingEl = document.getElementById('loadingState');
            try {
                const response = await fetch('data/tel-holders.json', { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                telData = await response.json();
                const order = ['combined', ...new Set(telData.chainOrder || Object.keys(telData.chains || {}))];
                buildToggle(order);
                setActiveToggle('combined');

                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated) {
                    lastUpdated.textContent = `Last updated: ${formatTimestamp(telData.generatedAt)}`;
                }

                document.getElementById('controls').style.display = 'block';
                document.getElementById('results').style.display = 'block';
                document.getElementById('downloadBtn').disabled = false;
                if (loadingEl) loadingEl.style.display = 'none';

                currentView = 'combined';
                displayResults(getViewData(currentView));
            } catch (error) {
                console.error('Snapshot load failed:', error);
                if (loadingEl) loadingEl.textContent = 'Failed to load holder snapshot.';
                showAlert(`Failed to load data: ${error.message}`);
            }
        }

        function buildToggle(order) {
            const toggle = document.getElementById('chainToggle');
            if (!toggle) return;
            toggle.innerHTML = '';

            order.forEach((key) => {
                if (key !== 'combined' && !telData?.chains?.[key]) return;
                const button = document.createElement('button');
                button.textContent = key === 'combined' ? 'Combined' : telData.chains[key].label || key;
                button.dataset.viewKey = key;
                button.classList.toggle('active', key === currentView);
                button.addEventListener('click', () => {
                    if (currentView === key) return;
                    currentView = key;
                    setActiveToggle(key);
                    displayResults(getViewData(key));
                });
                toggle.appendChild(button);
            });
        }

        function setActiveToggle(viewKey) {
            document.querySelectorAll('#chainToggle button').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.viewKey === viewKey);
            });
        }

        function getViewData(viewKey) {
            if (!telData) return null;
            if (viewKey === 'combined') {
                return { ...telData.combined, key: 'combined', label: telData.combined?.label || 'Combined' };
            }
            const chain = telData.chains?.[viewKey];
            if (!chain) return null;
            return { ...chain, key: viewKey, label: chain.label || viewKey };
        }

        function displayResults(view) {
            if (!view) {
                showAlert('No data available for the selected view.');
                return;
            }

            setActiveToggle(view.key);

            const holders = view.holders || [];
            const metrics = view.metrics || {};
            const excludedAddresses = new Set(view.excludedAddresses || []);
            const excludedBalances = view.excludedBalances || {};
            const totalProcessedByChain = view.totalProcessedByChain || {};

            const totalRetailSupply = view.totalRetailSupply || 0;
            const totalHolders = view.retailHolderCount ?? holders.length;
            const totalExcluded = Object.values(excludedBalances).reduce((sum, value) => sum + value, 0);
            const totalProcessed = Object.values(totalProcessedByChain).reduce((sum, value) => sum + value, 0);
            const label = view.label || (view.key === 'combined' ? 'Combined' : view.key);
            const isCombined = view.key === 'combined';

            renderSummaryCard(label, isCombined, totalHolders, totalRetailSupply, totalExcluded, totalProcessed);
            renderMetrics(metrics);
            renderExcludedSection(excludedAddresses, excludedBalances, totalExcluded);
            renderTopHoldersTable(holders, totalRetailSupply, label, isCombined);
            renderDistribution(metrics.distribution || [], totalRetailSupply);
        }

        function renderSummaryCard(label, isCombined, totalHolders, totalRetailSupply, totalExcluded, totalProcessed) {
            const summaryCard = document.getElementById('summaryCard');
            if (!summaryCard) return;

            const items = [
                { value: totalHolders.toLocaleString(), caption: 'Retail Holders' },
                {
                    value: formatNumber(totalRetailSupply),
                    caption: `${label} Retail Supply (${percentage(totalRetailSupply, TOTAL_TEL_SUPPLY)}% of total)`
                },
                { value: formatNumber(totalExcluded), caption: 'Excluded Supply' }
            ];

            if (isCombined) {
                items.push({ value: formatNumber(TOTAL_TEL_SUPPLY), caption: 'Total TEL Supply' });
                const chainKeys = telData.chainOrder || Object.keys(telData.chains || {});
                chainKeys.forEach((key) => {
                    const chain = telData.chains?.[key];
                    if (!chain) return;
                    items.push({
                        value: formatNumber(chain.totalRetailSupply),
                        caption: `${chain.label || key} Retail`
                    });
                });
            } else {
                items.push({
                    value: formatNumber(totalProcessed),
                    caption: `${label} Supply Covered`
                });
            }

            const unaccounted = isCombined ? Math.max(TOTAL_TEL_SUPPLY - totalProcessed, 0) : 0;

            summaryCard.innerHTML = `
                <h2 style="color: white; margin-top: 0;">${label} Snapshot</h2>
                <div class="summary-grid">
                    ${items.map((item) => `
                        <div class="summary-item">
                            <div class="summary-value">${item.value}</div>
                            <div class="summary-label">${item.caption}</div>
                        </div>
                    `).join('')}
                </div>
                ${isCombined && unaccounted > 1_000_000 ? `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 14px;">
                        <strong>Note:</strong> ${formatNumber(unaccounted)} TEL (${percentage(unaccounted, TOTAL_TEL_SUPPLY)}%) not accounted for in this snapshot – likely on other chains, locked, or burned.
                    </div>
                ` : ''}
            `;
        }

        function renderMetrics(metrics) {
            const metricsGrid = document.getElementById('metricsGrid');
            if (!metricsGrid) return;
            metricsGrid.innerHTML = '';

            [10, 25, 50, 100].forEach((n) => {
                const metric = metrics[`top${n}`];
                if (!metric) return;
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">Top ${n} Holders</div>
                    <div class="metric-value">${metric.percentage}%</div>
                    <div style="font-size: 12px; color: #666;">
                        ${formatNumber(metric.balance)} TEL<br>
                        ${metric.count} addresses
                    </div>
                `;
                metricsGrid.appendChild(card);
            });

            const giniCard = document.createElement('div');
            giniCard.className = 'metric-card';
            giniCard.innerHTML = `
                <div class="metric-label">Distribution Spread (Gini)</div>
                <div class="metric-value">${((metrics.gini || 0) * 100).toFixed(1)}%</div>
                <div style="font-size: 12px; color: #666;">
                    ${describeGini(metrics.gini || 0)}
                </div>
            `;
            metricsGrid.appendChild(giniCard);

            const stdCard = document.createElement('div');
            stdCard.className = 'metric-card';
            stdCard.innerHTML = `
                <div class="metric-label">Balance Std Deviation</div>
                <div class="metric-value">${formatNumber(metrics.stdDev || 0)}</div>
                <div style="font-size: 12px; color: #666;">TEL</div>
            `;
            metricsGrid.appendChild(stdCard);
        }

        function renderExcludedSection(excludedAddresses, excludedBalances, totalExcluded) {
            const excludedDiv = document.getElementById('excludedAddresses');
            if (!excludedDiv) return;

            const breakdown = Object.entries(excludedBalances)
                .map(([key, value]) => `${(telData.chains?.[key]?.label || key)}: ${formatNumber(value)} TEL`)
                .join(' | ') || 'No excluded balances in this view';

            excludedDiv.innerHTML = `
                <strong>Filtered Out:</strong> ${excludedAddresses.size} non-retail addresses<br>
                <strong>Excluded Balance:</strong> ${breakdown}<br>
                <strong>Total Excluded:</strong> ${formatNumber(totalExcluded)} TEL (${percentage(totalExcluded, TOTAL_TEL_SUPPLY)}% of total supply)<br>
                <strong>Retail Threshold:</strong> ${RETAIL_THRESHOLD.toLocaleString()} TEL &nbsp;|&nbsp;
                <strong>Mega Holder Threshold:</strong> ${formatNumber(MEGA_HOLDER_THRESHOLD)} TEL
            `;
        }

        function renderTopHoldersTable(holders, totalRetailSupply, label, isCombined) {
            const tbody = document.getElementById('topHoldersBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            holders.slice(0, 100).forEach((holder, index) => {
                const row = tbody.insertRow();
                const displayChain = isCombined ? holder.chain : label;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-family: monospace; font-size: 12px;">
                        ${holder.address.substring(0, 6)}...${holder.address.substring(holder.address.length - 4)}
                    </td>
                    <td>${formatNumber(holder.balance)}</td>
                    <td>${percentage(holder.balance, totalRetailSupply)}% retail | ${percentage(holder.balance, TOTAL_TEL_SUPPLY)}% total</td>
                    <td>${displayChain}</td>
                `;
            });
        }

        function renderDistribution(distribution, totalRetailSupply) {
            const distDiv = document.getElementById('distributionAnalysis');
            if (!distDiv) return;
            distDiv.innerHTML = '<h3>Holdings Distribution by Range</h3>';

            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Range (TEL)</th>
                        <th>Holders</th>
                        <th>Total Balance</th>
                        <th>% of Supply</th>
                    </tr>
                </thead>
                <tbody>
                    ${distribution.map((entry) => `
                        <tr>
                            <td>${entry.label}</td>
                            <td>${entry.count.toLocaleString()}</td>
                            <td>${formatNumber(entry.totalBalance)}</td>
                            <td>${percentage(entry.totalBalance, totalRetailSupply)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            distDiv.appendChild(table);
        }

        function describeGini(gini) {
            if (gini < 0.3) return 'Low concentration';
            if (gini < 0.6) return 'Moderate concentration';
            return 'High concentration';
        }

        function showAlert(message, type = 'error') {
            const alertsDiv = document.getElementById('alerts');
            if (!alertsDiv) return;
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            setTimeout(() => alert.remove(), type === 'error' ? 7000 : 4000);
        }

        function formatNumber(num) {
            if (!Number.isFinite(num)) return '0';
            if (num >= 1e9) return `${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `${(num / 1e3).toFixed(2)}K`;
            return num.toFixed(2);
        }

        function percentage(value, total) {
            if (!total || !Number.isFinite(value)) return '0.00';
            return ((value / total) * 100).toFixed(2);
        }

        function formatTimestamp(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return isoString;
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function downloadResults() {
            const view = getViewData(currentView);
            if (!view) {
                showAlert('No data to download.');
                return;
            }

            let csv = `View,${view.label}\nGenerated At,${telData.generatedAt}\n\n`;
            csv += 'Rank,Address,Balance (TEL),% of Retail Supply,% of Total Supply,Chain\n';
            (view.holders || []).slice(0, 100).forEach((holder, index) => {
                csv += `${index + 1},${holder.address},${holder.balance},${percentage(holder.balance, view.totalRetailSupply)},${percentage(holder.balance, TOTAL_TEL_SUPPLY)},${view.key === 'combined' ? holder.chain : view.label}\n`;
            });

            csv += '\nConcentration Metrics\n';
            ['top10', 'top25', 'top50', 'top100'].forEach((key) => {
                const metric = view.metrics?.[key];
                if (!metric) return;
                csv += `${key.toUpperCase()},${metric.percentage},${metric.balance},${metric.count}\n`;
            });
            csv += `Gini,${view.metrics?.gini ?? 0}\nStdDeviation,${view.metrics?.stdDev ?? 0}\n`;

            csv += '\nDistribution\n';
            (view.metrics?.distribution || []).forEach((entry) => {
                csv += `${entry.label},${entry.count},${entry.totalBalance},${percentage(entry.totalBalance, view.totalRetailSupply)}\n`;
            });

            csv += '\nExcluded Addresses\n';
            csv += `Count,${view.excludedAddresses?.length || 0}\n`;
            Object.entries(view.excludedBalances || {}).forEach(([key, value]) => {
                csv += `${telData.chains?.[key]?.label || key},${value}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tel-${currentView}-holders.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        </script>
</body>
</html>
